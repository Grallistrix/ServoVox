<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ServoVOX</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 16px;
    }
    .chat {
      max-width: 800px;
      margin: auto;
    }
    .msg {
      margin: 8px 0;
      padding: 10px;
      border-radius: 10px;
      max-width: 70%;
    }
    .user { background: #2962ff; margin-left: auto; }
    .bot { background: #333; }
    button { margin-left: 4px; }
  </style>
</head>
<body>

<div class="chat" id="chat"></div>

<div style="display:flex; margin-top:10px;">
  <input id="text" placeholder="Napisz wiadomoÅ›Ä‡..." style="flex:1;" />
  <button onclick="sendText()">Send</button>
  <button onclick="recordVoice()">ðŸŽ™</button>
</div>

<script>
const API = "http://192.168.0.10:8000";
const chat = document.getElementById("chat");

function addMsg(text, who, audioUrl=null) {
  const div = document.createElement("div");
  div.className = `msg ${who}`;
  div.innerHTML = `<div>${text}</div>`;
  if (audioUrl) {
    const audio = document.createElement("audio");
    audio.controls = true;
    audio.src = audioUrl;
    div.appendChild(audio);
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function sendText() {
  const input = document.getElementById("text");
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  addMsg(text, "user");

  const res = await fetch(`${API}/text_to_text`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ text })
  });

  const data = await res.json();
  addMsg(data.text, "bot");
}

async function recordVoice() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const rec = new MediaRecorder(stream);
  const chunks = [];

  rec.ondataavailable = e => chunks.push(e.data);
  rec.start();

  addMsg("[nagrywanie 10s...]", "user");

  setTimeout(() => rec.stop(), 10000);

  rec.onstop = async () => {
    const blob = new Blob(chunks, { type: "audio/webm" });
    const file = new File([blob], "input.webm");

    const form = new FormData();
    form.append("file", file);

    const res = await fetch(`${API}/audio_to_audio`, {
      method: "POST",
      body: form
    });

    const audioBlob = await res.blob();
    const audioUrl = URL.createObjectURL(audioBlob);

    addMsg("OdpowiedÅº gÅ‚osowa", "bot", audioUrl);
  };
}
</script>

</body>
</html>
